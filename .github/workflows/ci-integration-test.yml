name: CI - Integration tests

on:
  #push:
    #branches: [ "main" ]
  #pull_request:
    #branches: [ "main" ]
  workflow_dispatch:

env:
  TEST_IMAGE: idukelu/helm:latest
  REGISTRY_URL: http://127.0.0.1:8080

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
       
      # Install Helm on VM 
      - name: Install Helm
        run: |
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
          chmod 700 get_helm.sh
          ./get_helm.sh
      
      # Build Docker image from backend directory
      - name: Build app Docker image
        working-directory: ./backend
        run: docker build -t registry:test .
      
      - name: Run Docker container
        run: docker run -d -p 8080:8080 registry:test
      
      # Check if the app is running
      - name: Test 0 - Check container is running
        run: docker ps | grep registry:test

      # Run tests
      - name: Test 1 - Repo add
        run: helm repo add testrepo $REGISTRY_URL
